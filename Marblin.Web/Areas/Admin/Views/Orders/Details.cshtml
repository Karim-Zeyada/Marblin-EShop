@model Marblin.Core.Entities.Order
@{
    ViewData["Title"] = $"Order {Model.OrderNumber}";
}

<div class="admin-header">
    <h1>Order @Model.OrderNumber</h1>
    <a asp-action="Index" class="btn btn-outline-dark">← Back to Orders</a>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show"><button type="button" class="btn-close" data-bs-dismiss="alert"></button>@TempData["Success"]</div>
}

<div class="row">
    <div class="col-md-8">
        <!-- Order Items -->
        <div class="stat-card mb-4">
            <h5 class="mb-3">Order Items</h5>
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Variant</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.OrderItems)
                    {
                        <tr>
                            <td>@item.ProductName</td>
                            <td>@item.VariantDescription</td>
                            <td>@item.Quantity</td>
                            <td>@item.UnitPrice.ToString("C2")</td>
                            <td>@item.LineTotal.ToString("C2")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="4" class="text-end">Total:</th>
                        <th>@Model.TotalAmount.ToString("C2")</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Payment -->
        <div class="stat-card mb-4">
            <h5 class="mb-3">Payment</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Deposit (@Model.DepositPercentage%):</strong> @Model.DepositAmount.ToString("C2")</p>
                    <p><strong>Remaining:</strong> @Model.RemainingBalance.ToString("C2")</p>
                    <p>
                        <strong>Status:</strong>
                        @if (Model.IsDepositVerified)
                        {
                            <span class="badge bg-success">Verified on @Model.DepositVerifiedAt?.ToString("MMM d, yyyy")</span>
                        }
                        else
                        {
                            <span class="badge bg-warning text-dark">Pending Verification</span>
                        }
                    </p>
                </div>
                <div class="col-md-6">
                    @if (Model.PaymentProofType == Marblin.Core.Enums.PaymentProofType.TransactionId)
                    {
                        <p><strong>Transaction ID:</strong> <code>@Model.TransactionId</code></p>
                    }
                    else if (Model.PaymentProofType == Marblin.Core.Enums.PaymentProofType.ReceiptImage)
                    {
                        <p><strong>Receipt:</strong></p>
                        <a href="@Model.ReceiptImageUrl" target="_blank">
                            <img src="@Model.ReceiptImageUrl" style="max-width: 200px; border-radius: 4px;" />
                        </a>
                    }
                </div>
            </div>
            @if (!Model.IsDepositVerified)
            {
                <form asp-action="VerifyDeposit" asp-route-id="@Model.Id" method="post" class="mt-3">
                    <button type="submit" class="btn btn-success" onclick="return confirm('Mark deposit as verified?');">✓ Verify Deposit</button>
                </form>
            }
        </div>
    </div>

    <div class="col-md-4">
        <!-- Customer -->
        <div class="stat-card mb-4">
            <h5 class="mb-3">Customer</h5>
            <p><strong>@Model.CustomerName</strong></p>
            <p>@Model.Email</p>
            <p>@Model.Phone</p>
            <hr />
            <p class="small text-muted mb-0">
                @Model.AddressLine<br />
                @Model.City, @Model.Region<br />
                @Model.Country @Model.PostalCode
            </p>
        </div>

        <!-- Status -->
        <div class="stat-card">
            <h5 class="mb-3">Status</h5>
            
            <!-- Timeline -->
            <div class="mb-3">
                @{
                    var statuses = new[] {
                        (Marblin.Core.Enums.OrderStatus.PendingDeposit, "Pending", Model.CreatedAt),
                        (Marblin.Core.Enums.OrderStatus.InProduction, "Production", Model.InProductionAt),
                        (Marblin.Core.Enums.OrderStatus.AwaitingBalance, "Awaiting", Model.AwaitingBalanceAt),
                        (Marblin.Core.Enums.OrderStatus.Shipped, "Shipped", Model.ShippedAt)
                    };
                }
                @foreach (var (status, label, date) in statuses)
                {
                    var isCurrent = Model.Status == status;
                    var isPast = Model.Status > status;
                    <div class="d-flex align-items-center mb-2">
                        <div style="width: 20px; height: 20px; border-radius: 50%; background: @(isPast || isCurrent ? "#1a1a1a" : "#ddd"); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px;">
                            @if (isPast || isCurrent) { <span>✓</span> }
                        </div>
                        <div class="ms-2">
                            <strong style="color: @(isCurrent ? "#c9a962" : "#333");">@label</strong>
                            @if (date.HasValue || status == Marblin.Core.Enums.OrderStatus.PendingDeposit)
                            {
                                <small class="text-muted d-block">@((date ?? Model.CreatedAt).ToString("MMM d, h:mm tt"))</small>
                            }
                        </div>
                    </div>
                }
            </div>

            @if (Model.Status != Marblin.Core.Enums.OrderStatus.Shipped && Model.Status != Marblin.Core.Enums.OrderStatus.Cancelled)
            {
                <form asp-action="UpdateStatus" asp-route-id="@Model.Id" method="post">
                    <div class="input-group">
                        <select name="newStatus" class="form-select">
                            @foreach (var s in Enum.GetValues<Marblin.Core.Enums.OrderStatus>())
                            {
                                @if (s != Marblin.Core.Enums.OrderStatus.Cancelled)
                                {
                                    <option value="@s" selected="@(s == Model.Status)">@s</option>
                                }
                            }
                        </select>
                        <button type="submit" class="btn btn-dark">Update</button>
                    </div>
                </form>
            }
        </div>
    </div>
</div>
