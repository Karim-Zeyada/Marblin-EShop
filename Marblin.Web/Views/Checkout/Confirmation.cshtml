@model Marblin.Core.Entities.Order
@{
    ViewData["Title"] = "Order Confirmation";
    var settings = ViewBag.Settings as Marblin.Core.Entities.SiteSettings;
}

<div class="container my-5 text-center confirmation-container animate-fade-in-up">
    <div class="mb-5">
        <div class="d-inline-flex align-items-center justify-content-center bg-dark text-white rounded-circle shadow-lg" style="width: 80px; height: 80px;">
            <i class="bi bi-check-lg fs-1"></i>
        </div>
    </div>
    <h1 class="serif-font mb-3 display-5">Thank You, @Model.CustomerName!</h1>
    <p class="lead text-secondary mb-5">Your order <strong>#@Model.OrderNumber</strong> has been placed successfully.</p>
    
    <div class="card border-0 shadow-lg text-start mb-5 overflow-hidden" style="max-width: 800px; margin: 0 auto;">
        <div class="card-header bg-dark text-white py-4 position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 w-100 h-100 glass-effect opacity-10"></div>
            <h5 class="mb-0 text-center text-uppercase letter-spacing-2 small position-relative z-1">Step 1: Deposit Payment</h5>
        </div>
        <div class="card-body p-5">
            @if (Model.IsDepositVerified)
            {
                 <div class="alert alert-success border-0 text-center py-4 bg-light">
                    <i class="bi bi-check-circle-fill text-success fs-3 mb-3 d-block"></i>
                    <strong class="h5 serif-font">Payment Verified!</strong>
                    <p class="text-secondary mb-0 mt-2">Your deposit has been verified. We are creating your order.</p>
                </div>
                <div class="text-center mt-4">
                     <a asp-controller="Order" asp-action="Details" asp-route-id="@Model.OrderNumber" class="btn btn-dark px-5 py-3 rounded-0 shadow-sm transition-all hover-translate-up">View Order Details</a>
                </div>
            }
            else if (Model.PaymentProofSubmittedAt.HasValue)
            {
                <div class="alert alert-success border-0 text-center py-4 bg-light">
                    <i class="bi bi-clock-history text-success fs-3 mb-3 d-block"></i>
                    <strong class="h5 serif-font">Payment Proof Submitted!</strong>
                    <p class="text-secondary mb-0 mt-2">We are currently verifying your payment. We will notify you via email once approved.</p>
                </div>
                 <div class="text-center mt-4">
                     <a asp-controller="Order" asp-action="Details" asp-route-id="@Model.OrderNumber" class="btn btn-outline-dark px-5 py-3 rounded-0">View Order Details</a>
                </div>
            }
            else
            {
                <div class="text-center mb-5">
                    @if (Model.PaymentMethod == Marblin.Core.Enums.PaymentMethod.FullPaymentUpfront)
                    {
                        <h5 class="mb-3 serif-font h4">Total Due: <span class="text-success">@Model.TotalAmount.ToString("C0")</span></h5>
                        <p class="text-secondary small">Please transfer the full amount to one of the following accounts:</p>
                    }
                    else
                    {
                        <h5 class="mb-3 serif-font h4">Deposit Due: <span class="text-primary">@Model.DepositAmount.ToString("C0")</span></h5>
                        <p class="text-secondary small">Please transfer the deposit amount to one of the following accounts:</p>
                    }
                    
                    <div class="row g-3 justify-content-center mt-4">
                        @if (!string.IsNullOrEmpty(settings?.InstapayAccount))
                        {
                            <div class="col-md-5">
                                <div class="p-4 border text-center bg-light transition-all hover-shadow-sm h-100">
                                    <strong class="d-block mb-2 text-uppercase small letter-spacing-2 text-secondary">Instapay</strong>
                                    <i class="bi bi-qr-code-scan fs-4 mb-2 d-block text-dark opacity-50"></i>
                                    <span class="text-monospace fs-5 fw-bold text-dark">@settings.InstapayAccount</span>
                                </div>
                            </div>
                        }
                         @if (!string.IsNullOrEmpty(settings?.VodafoneCashNumber))
                        {
                            <div class="col-md-5">
                                 <div class="p-4 border text-center bg-light transition-all hover-shadow-sm h-100">
                                    <strong class="d-block mb-2 text-uppercase small letter-spacing-2 text-secondary">Vodafone Cash</strong>
                                    <i class="bi bi-phone fs-4 mb-2 d-block text-dark opacity-50"></i>
                                    <span class="text-monospace fs-5 fw-bold text-dark">@settings.VodafoneCashNumber</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="separator-line mx-auto mb-5"></div>

                <h6 class="mb-4 text-center text-uppercase letter-spacing-2 fw-bold text-secondary serif-font" style="font-size: 0.85rem;">Submit Payment Proof</h6>
                <form asp-action="UploadPaymentProof" method="post" enctype="multipart/form-data" class="col-md-11 mx-auto">
                    <input type="hidden" name="orderId" value="@Model.Id" />
                    
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger small rounded-0 text-center mb-4">@TempData["Error"]</div>
                    }
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success small rounded-0 text-center mb-4">@TempData["Success"]</div>
                    }

                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="payment-option-card p-4 border text-center transition-all h-100">
                                <label class="d-block mb-3 text-uppercase small letter-spacing-1 fw-bold text-secondary serif-font">Upload Receipt</label>
                                <div class="file-input-wrapper position-relative">
                                    <input type="file" name="receiptImage" class="form-control rounded-0 border-0 bg-transparent text-center p-0" accept="image/*" id="receiptInput" />
                                    <div class="custom-file-label d-flex flex-column align-items-center justify-content-center p-3" id="fileLabel">
                                        <i class="bi bi-cloud-upload fs-3 mb-2 text-muted opacity-50"></i>
                                        <span class="small text-muted">Tap to Choose File</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="payment-option-card p-4 border text-center transition-all h-100">
                                <label class="d-block mb-3 text-uppercase small letter-spacing-1 fw-bold text-secondary serif-font">Transaction ID</label>
                                <input type="text" name="transactionId" class="form-control rounded-0 border-0 bg-transparent text-center p-3 fs-6" placeholder="Transaction ID" style="background-color: #f8f9fa !important;" />
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-dark w-100 mt-5 py-3 rounded-0 text-uppercase letter-spacing-2 shadow-hover transition-all fw-bold">Submit Proof</button>
                </form>
            }
        </div>
    </div>
    
    <div class="text-center">
        <p class="small text-muted mb-4">You can check your order status anytime at <a asp-controller="Order" asp-action="Track" class="text-decoration-underline text-dark hover-opacity-75">Track Order</a> using your Order ID and Email.</p>
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-dark rounded-0 px-4 text-uppercase letter-spacing-2">Return Home</a>
    </div>
</div>

<style>
    .payment-option-card {
        background-color: #f8f9fa;
        border-color: #eee !important;
    }
    .payment-option-card:focus-within {
        border-color: #333 !important;
        background-color: #fff;
    }
    .file-input-wrapper input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
        z-index: 2;
    }
    .custom-file-label {
        background-color: #f8f9fa;
        min-height: 58px;
        transition: all 0.3s ease;
    }
    .file-input-wrapper:hover .custom-file-label {
        background-color: #e9ecef;
    }
</style>

<script>
    document.getElementById('receiptInput').addEventListener('change', function(e) {
        var fileName = e.target.files[0] ? e.target.files[0].name : "Tap to Choose File";
        var fileLabel = document.getElementById('fileLabel');
        fileLabel.innerHTML = '<i class="bi bi-file-earmark-check fs-3 mb-2 text-success"></i><span class="small text-dark fw-bold">' + fileName + '</span>';
    });
</script>
